@model Apartments_io.Areas.Manager.ViewModels.Bills.IndexViewModel

<h2>Bills</h2>

<!--Create-->
<h3>Create</h3>
<table class="table">
    <thead class="thead-dark">
        <tr>
            <th class="text-center">Resident</th>
            <th class="text-center">Apartment</th>
            <th class="text-center">Apartment Img</th>
            <th class="text-center w-100px">Create</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <select id="residents" class="form-control">
                    @foreach (User renter in Model.Renters)
                    {
                        <option value="@renter.Id">@renter.ToString()</option>
                    }
                </select>
            </td>

            <td>
                <select id="apartments" class="form-control"></select>
            </td>

            <td class="text-center">
                <img src="~/uploads/files/apartment/noimage.png" id="apartment-image" width="150" height="100" />
            </td>
            <td>
                <button id="create-new-bill" class="btn btn-success">Create</button>
            </td>
        </tr>
    </tbody>
</table>

<!--Filter-->
<h3>Filter</h3>
<p class="mb-0">Rows: <span class="text-primary">@Model.TotalRecordsAmount</span></p>
<form method="get" id="filter-form">
    <div class="form-inline">
        <input type="hidden" name="page" value="1" />

        <p class="mb-0 mr-2">Resident name</p>
        <select id="filter-residents" class="form-control mr-2" name="filterResidentId">
            <option disabled selected hidden value="-1">Select user here</option>
            @foreach (User renter in Model.Renters)
            {
                <option value="@renter.Id">@renter.ToString()</option>
            }
        </select>

        <p class="mb-0 mlr-2">Bill status</p>
        <select id="filter-bills" class="form-control ml-2" name="filterBillStatus">
            @foreach (DataAccess.Enums.PaymentStatus status in Enum.GetValues(typeof(DataAccess.Enums.PaymentStatus)))
            {
                <option value="@(Convert.ToInt32(status))">@status.GetText()</option>
            }
        </select>
        <a asp-action="Index" class="btn btn-secondary m-2">Reset</a>
        <input type="submit" value="Filtering" class="btn btn-secondary m-2"/>
    </div>
</form>


<!--List of item-->
<h2>List</h2>
<table id="bills-list" class="table">
    <thead class="thead-dark">
        <tr>
            <th>Resident</th>
            <th class="text-center">Apartment img</th>
            <th>Apartment</th>
            <th>Status</th>
            <th class="text-center w-100px">Update</th>
        </tr>
    </thead>
    <tbody>
        @foreach (Bill bill in Model.Bills)
        {
            <tr data-id="@bill.Id">
                <td>
                    @bill.Renter.ToString()
                </td>
                <td class="text-center">
                    <img src="@bill.Apartment.MainPhoto" width="150" height="100" />
                </td>
                <td>
                    @bill.Apartment.Name
                </td>
                <td>
                    <payment-status-update-select class="bill-status form-control" selected-status="@bill.PaymentStatus"></payment-status-update-select>
                    
                </td>
                <td>
                    <button class="btn btn-success btn-update">Update</button>
                </td>
            </tr>
        }
    </tbody>
</table>


<!--PAGINATION-->
<pagination-link pagination-model="Model.PaginationModel" controller-name="Bills" action-name="Index"></pagination-link>

@section Scripts
    {
    <script>
        $(document).ready()
        {
            load_apartments("#apartments", $("#residents option:selected").val(), function () {
                load_apartment_image("#apartment-image", $("#apartments option:selected").val());
            });

        }
        $("#residents").change(function () {
            load_apartments("#apartments", $("#residents option:selected").val(), function () {
                load_apartment_image("#apartment-image", $("#apartments option:selected").val());
            });
        });
        $("#apartments").change(function () {
            const apartment_id = $(this).children("option:selected").val();

            load_apartment_image("#apartment-image", apartment_id);
        });
        function load_apartment_image(image_selector, apartment_id) {

            if (typeof apartment_id === 'undefined') return;

            $.post('/Manager/Apartments/GetApartmentImage/',
                {
                    apartmentId: apartment_id
                }, function (data) {
                    $(image_selector).attr('src', data)
                });
        }
        function load_apartments(combobox_selector, user_id, callback) {
            $.post('/Manager/Apartments/GetApartmentsList/',
                {
                    userId: user_id,
                },
                function (data) {

                    const combobox = $(combobox_selector);
                    combobox.empty();
                    for (var i = 0; i < data.length; ++i) {
                        combobox.append('<option value="' + data[i].id + '">' + data[i].name + '</option>');
                    }

                    // call callback function
                    if (typeof callback === 'function') callback();
                });
        }

        // CREATE
        $("#create-new-bill").click(function () {

            $.post("/Manager/Bills/CreateNewBill/",
                {
                    residentId: $("#residents option:selected").val(),
                    apartmentId: $("#apartments").children("option:selected").val(),
                })
                .done(function () { location.reload(); })
                .fail(function () { alert("fail"); });
        });

        // UPDATE
        $("#bills-list tr").each(function () {
            const row = this;

            $(row).find(".btn-update").click(function () {

                // get select value
                const select_payment_status_value = $(row).find('.bill-status option:selected').val();

                // confirm updating
                var do_update_bill = true;
                if (select_payment_status_value == "2")// overdue
                {
                    do_update_bill = confirm("In this case, the renter will lose an apartment. Are you sure?");
                }

                // send update request to the server
                if (do_update_bill) {

                    $.post("/Manager/Bills/UpdateBill/",
                        {
                            billId: $(row).data("id"),
                            paymentStatus: select_payment_status_value

                        },
                        function (data) {
                            
                            if (data.isRedirect) window.location.href = data.location;
                        })
                        
                        .done(function () { alert("updated") })
                        .fail(function () { alert("fail") });
                }
            });
        });
        
    </script>

}